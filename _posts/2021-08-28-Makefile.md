---
layout:     post
title:      Makefile
subtitle:   
date:       2021-08-28
author:     DW
header-img: img/post/post-bg-2.jpg
catalog: true
tags:
    - Makefile
---

official manual: [Manual](https://www.gnu.org/software/make/manual/make.html)

#### generate array
```
E:=$(shell seq -f "%03g" 1 1 100)
```

####
```
E:=$(shell echo {1..5})
E:=$(shell echo {1..5}_{1..5})
```

#### filename and replace
```
srl:=$(wildcard ./*.log)
dst:=$(srl:%.log=%.h5)
```

#### fast iteration
```
x:=$(shell echo {1..5}_{1..5}_{1..5})
grid:=$(subst _,\ ,$(x))
```

#### iteration out of target
```
E1:=$(shell echo {1..5})
E2:=$(shell echo {1..3})

target :=
target += $(foreach x, $(E1), $\
                $(foreach y, $(E2), $(shell echo $(x)/$(y).log)))
```
or
```
target := $(foreach x, $(E1), $\
                $(foreach y, $(E2), $(shell echo $(x)/$(y).log)))
```

#### iteration by function

```
define MODULE_TEMPLATE_rule
    recon/$$(ax1)$$(ax2)/$$(ax1)_$(1)_$$(ax2)_$(2).h5:
        mkdir -p $$(dir $$@)
        python3 em.py -o $$@ --coeff square/traditional1.h5 --r_max 900 -i $$(ax1) $(1) $$(ax2) $(2)

define MODULE_rule
    $(foreach template,$(TEMPLATES),$(eval $(call MODULE_TEMPLATE_rule,$(1),$(template))))
endef

$(foreach module,$(MODULES),$(eval $(call MODULE_rule,$(module))))
```

#### iteration in target

```
all1:
    @for x in $(E1);\
    do \
            for y in $(E2);\
            do \
                    echo $$x $$y; \
            done \
    done
```

#### template for dependence in iteration
```
define tpl_iter
    $(guile (+ $(1) 1))/%.h5: data/type1/%.root $(1)/%.h5
        mkdir -p $$(dir $$@)
        python3 Recon_bak.py $(1) $$@ $$^
endef

$(foreach i,$(iterl),$(eval $(call tpl_iter,$(i))))
```

#### create path
```
    mkdir -p $(dir $@)
```
or
```
    mkdir -p $(dirname $@)
```
#### automatic variables
| variable | mean |
| --- | --- |
|  `$@`   | target  |
|  `$%`   | target member name  |
|  `$<`   | first prerequisite |
|  `$?`   | all prerequisites |
|  `$*`   | match `%` |
