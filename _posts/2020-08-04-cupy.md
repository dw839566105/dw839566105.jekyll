---
layout:     post
title:      Cupy (教程翻译)
subtitle:   
date:       2020-08-04
author:     BY DW
header-img: img/post/post-bg-2.jpg
catalog: true
tags:
    - GPU
---
[参考资料](https://docs.cupy.dev/en/stable/)

## GPU 基础
Host: CPU和内存
Device: GPU和显存

CPU结构: 每个core代表核，更大的为存储单元Cache和控制单元Memory Controller。
![CPU结构](https://raw.githubusercontent.com/dw839566105/dw839566105.github.io/master/img/GPU/Chip.png)
GPU结构：更多的面积用于处理任务
![GPU结构](https://raw.githubusercontent.com/dw839566105/dw839566105.github.io/master/img/GPU/GPU_stucture.png)
##### 流多处理器(Stream MultiProcessing, SM)
![SM](https://github.com/dw839566105/dw839566105.github.io/raw/master/img/GPU/SM.png)
一个 GPU 包含多个 Streaming Multiprocessor ，而每个 Streaming Multiprocessor 又包含多个处理不同数据类型的core 。寄存器和存储单元 Streaming Multiprocessors 支持并发执行多达几百的 thread.  
16个core共享一个解码器，32个共享一个上下文，WARP， 共享一个存储单元（较快）。
![1](https://github.com/dw839566105/dw839566105.github.io/raw/master/img/GPU/GPU_stucture1.png)  
一个 thread block 只能调度到一个 Streaming Multiprocessor 上运行，直到 thread block 运行完毕，不能存在于多个SM中。一个 Streaming Multiprocessor 可以同时运行多个thread block。

CUDA中的内存有可读写的全局内存，以及只读的纹理内存(texture memory,更适合于那种需要在图像间插值的应用? )以及常量内存(constant memory,用于保存在Kernel执行期间不会发生变化的数据。NVIDIA硬件提供64KB的Constan Memory。在某些情况，用Constant Memory替换Global Memory能有效的减少内存带宽。)
而shared memory为block私有，local memory为thread私有，读写速度快。
![Memory](https://github.com/dw839566105/dw839566105.github.io/raw/master/img/GPU/Memory.png)

## CuPy基础
### 概述
Cupy是CUDA对numpy多维数组计算兼容性的提升，由cupy.ndarray组成，核心包括多维数组类和躲个函数。支持numpy接口的子集。
以下为支持Numpy接口的子集：
+ Basic indexing (indexing by ints, slices, newaxes, and Ellipsis)
+ Most of Advanced indexing (except for some indexing patterns with boolean masks)
+ Data types (dtypes): bool_, int8, int16, int32, int64, uint8, uint16, uint32, uint64, float16, float32, float64, complex64, complex128
+ Most of the array creation routines (empty, ones_like, diag, etc.)
+ All operators with broadcasting
+ All universal functions for elementwise operations (except those for complex numbers).
+ Linear algebra functions, including product (dot, matmul, etc.) and decomposition (cholesky, svd, etc.), accelerated by cuBLAS.
+ Reduction along axes (sum, max, argmax, etc.)

CuPy还包括以下一些特征：
+ User-defined elementwise CUDA kernels
+ User-defined reduction CUDA kernels
+ Fusing CUDA kernels to optimize user-defined calculation
+ Customizable memory allocator and memory pool
+ cuDNN utilities

CuPy 使用即时的综合体(?)：当需要调用一个核时，会根据数据形状和类型来优化编译代码，并传输给GPU设备在核中执行。编译的代码缓存位于$(HOME)/.cupy/kernel_cache目录，可通过设置环境变量CUPY_CACHE_DIR改变。第一次调用核时可能会比较慢，第二次就会解决。CuPy这个过程中也会将编译代码的缓存输入GPU设备，减少了进一步调用的核转换的时间。

